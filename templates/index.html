<!DOCTYPE html>
<html>

<head>
    <title>Nutzwertanalyse</title>
    <style>
        table,
        th,
        td {
            border: 1px solid black;
            border-collapse: collapse;
            padding: 5px;
        }

        input[type="number"],
        input[type="text"] {
            width: 80px;
        }

        button {
            margin: 5px;
        }
    </style>
    <script>
        function addCriterion() {
            const table = document.getElementById('nwa-table');
            const row = table.insertRow(-1);
            const cells = table.rows[1].cells.length;

            let nameCell = row.insertCell(0);
            nameCell.innerHTML = '<input name="criterion_name" required>';

            let weightCell = row.insertCell(1);
            weightCell.innerHTML = '<input name="weight" type="number" required>';

            for (let i = 2; i < cells - 1; i++) {
                row.insertCell(i).innerHTML = `<input name="score_${row.rowIndex - 2}_${i - 2}" type="number" required>`;
            }

            let removeCell = row.insertCell(-1);
            removeCell.innerHTML = `<button type="button" onclick="removeRow(this)">üóëÔ∏è</button>`;
        }

        function addOption() {
            const table = document.getElementById('nwa-table');
            const headerRow = table.rows[0];
            const bodyRows = Array.from(table.rows).slice(1); // exclude header

            const newIndex = headerRow.cells.length - 2;
            const name = prompt("Name der neuen Option:");
            if (!name) return;

            // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∫–Ω–æ–ø–∫–æ–π —É–¥–∞–ª–µ–Ω–∏—è
            const th = document.createElement("th");
            th.innerHTML = `<input name="option_name" value="${name}" required><br><button type="button" onclick="removeColumn(this)">üóëÔ∏è</button>`;
            headerRow.insertBefore(th, headerRow.lastElementChild);

            // –î–æ–±–∞–≤–ª—è–µ–º —è—á–µ–π–∫–∏ —Å input –≤ –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ–∫—É
            bodyRows.forEach((row, rowIndex) => {
                const td = document.createElement("td");
                td.innerHTML = `<input name="score_${rowIndex}_${newIndex}" type="number" max="10" required>`;
                row.insertBefore(td, row.lastElementChild);
            });
        }

        function removeRow(btn) {
            const row = btn.parentNode.parentNode;
            row.parentNode.removeChild(row);
        }

        function removeColumn(btn) {
            const cellIndex = btn.parentNode.cellIndex;
            const table = document.getElementById("nwa-table");

            for (let i = 0; i < table.rows.length; i++) {
                table.rows[i].deleteCell(cellIndex);
            }
        }
    </script>
</head>

<body>
    <h1>Nutzwertanalyse</h1>

    {% if error %}
    <p style="color: red;">‚ö†Ô∏è {{ error }}</p>
    {% endif %}

    <form method="post">
        <table id="nwa-table">
            <thead>
                <tr>
                    <th>Kriterium</th>
                    <th>Gewicht (%)</th>
                    {% set option_names = data.getlist("option_name") if data else ["Option A", "Option B"] %}
                    {% for name in option_names %}
                    <th>
                        <input name="option_name" value="{{ name }}" required>
                        <br><button type="button" onclick="removeColumn(this)">üóëÔ∏è</button>
                    </th>
                    {% endfor %}
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% set criteria = data.getlist("criterion_name") if data else ["Kosten", "Qualit√§t", "Lieferzeit"] %}
                {% set weights = data.getlist("weight") if data else ["3", "5", "2"] %}
                {% for i in range(criteria | length) %}
                <tr>
                    <td><input name="criterion_name" value="{{ criteria[i] }}" required></td>
                    <td><input name="weight" type="number" value="{{ weights[i] }}" required></td>
                    {% for j in range(option_names | length) %}
                    {% set field_name = "score_" ~ i ~ "_" ~ j %}
                    <td>
                        <input name="score_{{i}}_{{j}}" type="number" max="10"
                            value="{{ data.get(field_name, '') if data else '' }}" required>
                    </td>
                    {% endfor %}
                    <td><button type="button" onclick="removeRow(this)">üóëÔ∏è</button></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <br>
        <button type="button" onclick="addCriterion()">Kriterium hinzuf√ºgen</button>
        <button type="button" onclick="addOption()">Option hinzuf√ºgen</button>
        <br><br>
        <input type="submit" value="Berechnen">
    </form>

    {% if results %}
    <h2>Ergebnisse</h2>
    <ul>
        {% for res in results %}
        <li><strong>{{ res.name }}</strong>: {{ '%.2f' | format(res.score) }}</li>
        {% endfor %}
    </ul>
    {% endif %}
</body>

</html>